# ğŸ”§ CorreÃ§Ã£o Nginx - Backadmin Dev

**Data:** 01 Novembro 2025
**VersÃ£o:** v0.7.1
**Tipo:** CorreÃ§Ã£o de configuraÃ§Ã£o

---

## ğŸ› Problema Identificado

O backadmin em `https://dev.lusio.market/backadmin` estava carregando sem CSS/JavaScript, layout completamente quebrado.

### Causa Raiz

Mismatch entre configuraÃ§Ã£o do Nginx e porta do servidor Node.js:

```nginx
# Nginx (/etc/nginx/sites-available/dev-lusio)
location /backadmin {
    proxy_pass http://localhost:3003;  # âŒ PORTA ERRADA
    ...
}
```

```bash
# Servidor Node.js
PORT=3004 node server.js  # âœ… Rodando na 3004
```

**Resultado:** Nginx fazendo proxy para porta 3003 (nada rodando), enquanto servidor estava na 3004.

---

## âœ… SoluÃ§Ã£o Aplicada

### 1. Backup da ConfiguraÃ§Ã£o

```bash
ssh root@72.61.165.88 'cp /etc/nginx/sites-available/dev-lusio \
  /etc/nginx/sites-available/dev-lusio.bak.20251101_174500'
```

### 2. AtualizaÃ§Ã£o do Nginx

```bash
# Atualizar proxy_pass para porta correta
sed -i 's|proxy_pass http://localhost:3003;|proxy_pass http://localhost:3004;|' \
  /etc/nginx/sites-available/dev-lusio
```

**ConfiguraÃ§Ã£o corrigida:**

```nginx
location /backadmin {
    # Updated to port 3004 on 2025-11-01
    proxy_pass http://localhost:3004;  # âœ… CORRIGIDO
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 3. ValidaÃ§Ã£o e Reload

```bash
# Testar sintaxe
nginx -t
# âœ… nginx: configuration file /etc/nginx/nginx.conf test is successful

# Recarregar Nginx
systemctl reload nginx
# âœ… Success

# Testar acesso
curl -s -o /dev/null -w "%{http_code}" https://dev.lusio.market/backadmin
# âœ… 200
```

### 4. Rebuild Completo da AplicaÃ§Ã£o

Por precauÃ§Ã£o, tambÃ©m foi feito rebuild completo garantindo que todos assets estejam no lugar:

```bash
cd /var/www/dev/backadmin
rm -rf .next
npm install
npm run build
cp -r .next/static .next/standalone/.next/
cp -r public .next/standalone/
cp -r src .next/standalone/
cd .next/standalone
PORT=3004 nohup node server.js > /var/log/backadmin-dev.log 2>&1 &
```

---

## ğŸ“‹ Checklist de VerificaÃ§Ã£o

- [x] Backup do Nginx criado
- [x] ConfiguraÃ§Ã£o Nginx atualizada
- [x] Sintaxe Nginx validada
- [x] Nginx recarregado
- [x] Servidor respondendo na porta 3004
- [x] Acesso pÃºblico funcionando (HTTPS 200)
- [x] Assets estÃ¡ticos carregando
- [x] CSS/JavaScript aplicados corretamente
- [x] README.md atualizado com v0.7.1
- [x] Commit e push realizados

---

## ğŸ¯ Resultado

âœ… **AplicaÃ§Ã£o funcionando perfeitamente**
âœ… **Layout carregando com todos estilos**
âœ… **JavaScript executando corretamente**

**URL:** https://dev.lusio.market/backadmin
**Status:** 200 OK
**Porta interna:** 3004
**Proxy Nginx:** localhost:3004

---

## ğŸ“ LiÃ§Ãµes Aprendidas

1. **Sempre verificar mismatch de portas** entre Nginx e aplicaÃ§Ã£o
2. **Documentar portas** explicitamente no README
3. **Manter backups** antes de modificar configuraÃ§Ãµes
4. **Validar sintaxe** antes de recarregar serviÃ§os
5. **Testar acesso** apÃ³s cada mudanÃ§a

---

## ğŸ”— Arquivos Relacionados

- `/etc/nginx/sites-available/dev-lusio` - Config Nginx
- `/etc/nginx/sites-available/dev-lusio.bak.20251101_*` - Backup
- `/var/www/dev/backadmin/` - AplicaÃ§Ã£o
- `/var/log/backadmin-dev.log` - Logs do servidor
- `README.md` - DocumentaÃ§Ã£o atualizada

---

**Executado por:** Euclides Gomes + Claude Code
**Versionamento:** Commit 870c740 na branch `dev`
